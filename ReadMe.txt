based off from CI-3.0.4